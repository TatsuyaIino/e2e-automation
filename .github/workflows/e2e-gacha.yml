name: E2E Gacha Tests

on:
  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³
  workflow_dispatch:

  # main ãƒ–ãƒ©ãƒ³ãƒã« push ã•ã‚ŒãŸã‚‰å®Ÿè¡Œ
  push:
    branches: [ main ]

  # æ¯æ—¥ 21:00 UTCï¼ˆæ—¥æœ¬æ™‚é–“ 06:00é ƒï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: "0 21 * * *"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps

      - name: Run pytest
        env:
          CI: "true"
        run: |
          pytest -v test_gacha.py

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gacha-screenshots
          path: "*.png"

      - name: Upload videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gacha-videos
          path: videos/**/*.webm

      - name: Slack notification (always)
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            MESSAGE="ğŸ‰ E2Eãƒ†ã‚¹ãƒˆæˆåŠŸã—ã¾ã—ãŸï¼"
          else
            MESSAGE="âŒ E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸï¼"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\nãƒªãƒã‚¸ãƒˆãƒª: $GITHUB_REPOSITORY\nå®Ÿè¡Œãƒ­ã‚°: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
